@* =============================================================================
   ARQUIVO:      Index.cshtml
   MODULO:       GeradorEntidades
   VERSAO:       1.3.0
   DATA:         12/12/2025 13:00
   AUTOR:        IA (ChatGPT) sob solicita√ß√£o do desenvolvedor
   DESCRICAO:    Ajuste no layout e corre√ß√£o do carregamento do DataTable
   OBS:
   - Sempre que o arquivo for gerado COMPLETO por IA, a vers√£o deve ser incrementada.
   - Altera√ß√µes parciais N√ÉO alteram a vers√£o.
============================================================================= *@

@{
    ViewData["Title"] = "Gerador de Frontend";
    Layout = null; // P√°gina standalone sem layout
}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"] - Wizard</title>
    <link rel="stylesheet" href="~/css/generator/wizard.css" asp-append-version="true" />
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üöÄ Gerador de Frontend v3.7</h1>
            <p>Gere Views, Controllers, Models e JavaScript automaticamente</p>
            <div class="shortcuts-hint">
                <span title="Salvar estado">Ctrl+S</span>
                <span title="Desfazer √∫ltima a√ß√£o">Ctrl+Z</span>
                <span title="Fechar popups">Esc</span>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="step active" data-step="0">
                <div class="step-number">1</div>
                <div class="step-label">Entidade</div>
            </div>
            <div class="step" data-step="1">
                <div class="step-number">2</div>
                <div class="step-label">Valida√ß√£o</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">3</div>
                <div class="step-label">Listagem</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">4</div>
                <div class="step-label">Formul√°rio</div>
            </div>
            <div class="step" data-step="4">
                <div class="step-number">5</div>
                <div class="step-label">Gerar</div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- =========================================== -->
            <!-- STEP 0: Sele√ß√£o de Entidade -->
            <!-- =========================================== -->
            <div class="step-content active" data-step="0">
                <h2>üì• Etapa 1: Selecionar Entidade</h2>
                <p>Carregue do manifesto ou cole o JSON da entidade</p>

                <!-- Manifest Loader -->
                <div id="manifestLoader"></div>

                <hr style="margin: 20px 0; border-color: #e0e0e0;">

                <!-- Configura√ß√µes Obrigat√≥rias -->
                <div class="config-section">
                    <h3>‚öôÔ∏è Configura√ß√µes</h3>
                    <div class="alert alert-info" style="margin-bottom: 15px;">
                        <strong>üí° Dica:</strong> Os campos CdFuncao e √çcone s√£o opcionais.
                        Se deix√°-los vazios, ser√£o gerados automaticamente com base no m√≥dulo selecionado.
                    </div>

                    <div class="config-grid">
                        <!-- CdSistema - OBRIGAT√ìRIO -->
                        <div class="form-group">
                            <label for="cdSistema">
                                M√≥dulo/Sistema <span class="required">*</span>
                            </label>
                            <select id="cdSistema">
                                <option value="RHU">RHU - Gest√£o de Pessoas</option>
                                <option value="GTC">GTC - Gest√£o de Terceiros</option>
                                <option value="CAP">CAP - Controle Acesso Portaria</option>
                                <option value="CPO">CPO - Controle de Ponto</option>
                                <option value="TRE">TRE - Treinamento</option>
                                <option value="MSO">MSO - Sa√∫de Ocupacional</option>
                                <option value="SEG">SEG - Seguran√ßa</option>
                                <option value="AVA">AVA - Avalia√ß√£o</option>
                                <option value="ESO">ESO - eSocial</option>
                                <option value="EPI">EPI - Gest√£o de EPI</option>
                            </select>
                            <small>Selecione o m√≥dulo do sistema</small>
                        </div>

                        <!-- DisplayName - OBRIGAT√ìRIO -->
                        <div class="form-group">
                            <label for="displayName">
                                Nome de Exibi√ß√£o <span class="required">*</span>
                            </label>
                            <input type="text" id="displayName" placeholder="Ex: Tipos de Treinamento" />
                            <small>Nome que aparece no menu e t√≠tulos</small>
                        </div>

                        <!-- CdFuncao - OPCIONAL (auto-gerado) -->
                        <div class="form-group">
                            <label for="cdFuncao">
                                CdFuncao
                                <span class="badge badge-info">Opcional</span>
                            </label>
                            <input type="text" id="cdFuncao" placeholder="Auto-gerado: {MODULO}_FM_{ENTIDADE}" />
                            <small class="text-muted">
                                <strong>Auto-gerado como:</strong> TRE_FM_TRETIPOSTREINAMENTO<br>
                                Deixe vazio para gerar automaticamente
                            </small>
                        </div>

                        <!-- IconClass - OPCIONAL (auto-mapeado) -->
                        <div class="form-group">
                            <label for="iconClass">
                                √çcone
                                <span class="badge badge-info">Opcional</span>
                            </label>
                            <input type="text" id="iconClass" placeholder="Auto-mapeado por m√≥dulo" />
                            <small class="text-muted">
                                <strong>Mapeamento autom√°tico:</strong><br>
                                RHU=fas fa-users | TRE=fas fa-certificate | MSO=fas fa-heartbeat<br>
                                GTC=fas fa-hard-hat | SEG=fas fa-shield-alt | EPI=fas fa-vest
                            </small>
                        </div>
                    </div>
                </div>

                <hr style="margin: 20px 0; border-color: #e0e0e0;">

                <!-- JSON Manual -->
                <div class="form-group">
                    <label>JSON da Entidade (opcional - se n√£o usar manifesto):</label>
                    <textarea id="jsonInput" rows="12">{
  "entityName": "Exemplo",
  "tableName": "TB_EXEMPLO",
  "properties": [
    { "name": "Id", "type": "int", "nullable": false },
    { "name": "Nome", "type": "string", "nullable": false, "maxLength": 200 },
    { "name": "Descricao", "type": "string", "nullable": true, "maxLength": 500 },
    { "name": "Ativo", "type": "bool", "nullable": false }
  ]
}</textarea>
                </div>

                <div id="jsonError" class="alert alert-error" style="display: none;"></div>
                <div id="jsonSuccess" class="alert alert-success" style="display: none;"></div>

                <div class="navigation">
                    <div>
                        <button class="btn btn-secondary btn-small" onclick="App.confirmReset()" title="Remove todos os dados e configura√ß√µes">
                            üîÑ Limpar Tudo
                        </button>
                    </div>
                    <button class="btn btn-primary" onclick="validateAndNext(0)">Pr√≥ximo ‚Üí</button>
                </div>
            </div>

            <!-- =========================================== -->
            <!-- STEP 1: Schema Validation -->
            <!-- =========================================== -->
            <div class="step-content" data-step="1">
                <h2>üîç Etapa 2: Valida√ß√£o de Schema</h2>
                <p>Compare a estrutura da entidade com a tabela do banco de dados</p>

                <div id="schemaValidatorContent"></div>

                <div class="navigation">
                    <button class="btn btn-secondary" onclick="goToStep(0)">‚Üê Anterior</button>
                    <button class="btn btn-primary" onclick="validateAndNext(1)">Pr√≥ximo ‚Üí</button>
                </div>
            </div>

            <!-- =========================================== -->
            <!-- STEP 2: Grid Configuration -->
            <!-- =========================================== -->
            <div class="step-content" data-step="2">
                <h2>üìã Etapa 3: Configura√ß√£o da Listagem</h2>
                <p>Configure colunas, filtros e op√ß√µes do DataTables</p>

                <div class="alert alert-info">
                    <strong>üí° Dica:</strong> Se n√£o configurar colunas, ser√£o geradas automaticamente
                    at√© 8 colunas principais (excluindo campos de auditoria).
                </div>

                <div id="gridGeneralOptions"></div>
                <div id="columnConfig"></div>
                <div id="filterConfig"></div>

                <div class="navigation">
                    <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Anterior</button>
                    <button class="btn btn-primary" onclick="validateAndNext(2)">Pr√≥ximo ‚Üí</button>
                </div>
            </div>

            <!-- =========================================== -->
            <!-- STEP 3: Form Designer -->
            <!-- =========================================== -->
            <div class="step-content" data-step="3">
                <h2>üé® Etapa 4: Designer de Formul√°rio</h2>
                <p>Configure o layout e arraste os campos para o canvas</p>

                <div class="alert alert-info">
                    <strong>üí° Dica:</strong> Se n√£o arrastar campos, ser√£o gerados automaticamente
                    TODOS os campos (excluindo IDs auto-gerados e campos de auditoria).
                </div>

                <div id="layoutOptions"></div>

                <div class="form-designer">
                    <div class="fields-palette">
                        <h3>üì¶ Campos Dispon√≠veis</h3>
                        <div id="fieldsPalette"></div>
                    </div>

                    <div class="canvas" id="formCanvas">
                        <div class="canvas-empty">
                            <h3>Arraste os campos aqui</h3>
                            <p>Arraste campos da paleta √† esquerda para montar seu formul√°rio</p>
                            <p><small class="text-muted">Ou deixe vazio para gerar automaticamente</small></p>
                        </div>
                    </div>

                    <div class="field-config">
                        <h3>‚öôÔ∏è Configura√ß√£o do Campo</h3>
                        <div id="fieldConfigPanel">
                            <p style="color: #999; text-align: center; margin-top: 50px;">
                                Selecione um campo no canvas
                            </p>
                        </div>
                    </div>
                </div>

                <div class="navigation">
                    <button class="btn btn-secondary" onclick="goToStep(2)">‚Üê Anterior</button>
                    <button class="btn btn-primary" onclick="validateAndNext(3)">Pr√≥ximo ‚Üí</button>
                </div>
            </div>

            <!-- =========================================== -->
            <!-- STEP 4: Gera√ß√£o de C√≥digo -->
            <!-- =========================================== -->
            <div class="step-content" data-step="4">
                <h2>üöÄ Etapa 5: Gerar C√≥digo</h2>
                <p>Revise as op√ß√µes e gere os arquivos</p>

                <!-- Resumo da Configura√ß√£o -->
                <div class="config-summary" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0;">üìã Resumo da Configura√ß√£o</h3>
                    <div id="configSummary" style="font-family: monospace; font-size: 13px;">
                        <!-- Ser√° preenchido via JavaScript -->
                    </div>
                </div>

                <!-- Op√ß√µes de Gera√ß√£o -->
                <div class="generation-options">
                    <h3>üì¶ O que gerar?</h3>
                    <div class="checkbox-grid">
                        <label><input type="checkbox" id="optWebController" checked> WebController</label>
                        <label><input type="checkbox" id="optWebModels" checked> WebModels (DTOs)</label>
                        <label><input type="checkbox" id="optWebServices" checked> WebServices</label>
                        <label><input type="checkbox" id="optView" checked> View (Index.cshtml)</label>
                        <label><input type="checkbox" id="optJavaScript" checked> JavaScript</label>
                        <label><input type="checkbox" id="optEntidade"> Entidade (Backend)</label>
                    </div>
                </div>

                <!-- Bot√£o de Gera√ß√£o -->
                <div class="generation-actions">
                    <button class="btn btn-primary btn-large" onclick="ApiClient.generate()">
                        ‚ö° Gerar C√≥digo
                    </button>
                    <button class="btn btn-success btn-large" onclick="ApiClient.downloadZip()">
                        üì¶ Download ZIP
                    </button>
                </div>

                <!-- Loading -->
                <div id="generationLoading" style="display: none; text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p>Gerando c√≥digo...</p>
                </div>

                <!-- Resultado -->
                <div id="generationResult" style="display: none;">
                    <h3>‚úÖ Arquivos Gerados</h3>
                    <div id="generatedFilesList"></div>
                </div>

                <!-- Preview de C√≥digo -->
                <div id="codePreviewSection" style="display: none;">
                    <h3>üìÑ Preview do C√≥digo</h3>
                    <div class="code-tabs" id="codeTabsHeader"></div>
                    <div id="codeTabsContent"></div>
                </div>

                <div class="navigation">
                    <button class="btn btn-secondary" onclick="goToStep(3)">‚Üê Anterior</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="~/js/generator/app.js" asp-append-version="true"></script>
    <script src="~/js/generator/modules/wizard.js" asp-append-version="true"></script>
    <script src="~/js/generator/modules/manifest-manager.js" asp-append-version="true"></script>
    <script src="~/js/generator/modules/schema-validator.js" asp-append-version="true"></script>
    <script src="~/js/generator/modules/grid-config.js" asp-append-version="true"></script>
    <script src="~/js/generator/modules/form-designer.js" asp-append-version="true"></script>
    <script src="~/js/generator/modules/api-client.js" asp-append-version="true"></script>

    <script>
        // Inicializa quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Gerador v3.7 iniciado');

            // Carrega URL base da API (mesmo servidor)
            ApiClient.baseUrl = window.location.origin;

            // Inicializa Manifest Manager
            setTimeout(() => {
                if (App.modules.ManifestManager) {
                    App.modules.ManifestManager.render();
                }
            }, 100);

            // Mostra resumo na √∫ltima etapa
            window.showConfigSummary = function() {
                const entity = Store.get('entity') || {};
                const cdSistema = document.getElementById('cdSistema')?.value || 'N/A';
                const cdFuncao = document.getElementById('cdFuncao')?.value || 'Auto-gerado';
                const icon = document.getElementById('iconClass')?.value || 'Auto-mapeado';
                const formFields = Store.get('formFields') || [];

                const summary = `
                    <strong>Entidade:</strong> ${entity.entityName || 'N/A'}<br>
                    <strong>M√≥dulo:</strong> ${cdSistema}<br>
                    <strong>CdFuncao:</strong> ${cdFuncao}<br>
                    <strong>√çcone:</strong> ${icon}<br>
                    <strong>Campos Formul√°rio:</strong> ${formFields.length > 0 ? formFields.length + ' campos configurados' : 'Auto-gerado (todos os campos)'}<br>
                    <strong>Colunas Grid:</strong> ${typeof GridConfig !== 'undefined' && GridConfig.config?.columns?.length > 0 ? GridConfig.config.columns.length + ' colunas configuradas' : 'Auto-gerado (at√© 8 colunas)'}
                `;

                document.getElementById('configSummary').innerHTML = summary;
            };

            // Chama showConfigSummary quando chegar na etapa 4
            const originalValidateAndNext = window.validateAndNext;
            window.validateAndNext = function(step) {
                originalValidateAndNext(step);
                if (step === 3) { // Pr√≥ximo da etapa 3 = chegou na etapa 4
                    setTimeout(() => showConfigSummary(), 100);
                }
            };
        });
    </script>
</body>
</html>
