# üèóÔ∏è Arquitetura - RhSensoERP API

## üìã √çndice

- [Vis√£o Geral](#vis√£o-geral)
- [Clean Architecture](#clean-architecture)
- [Estrutura de Pastas](#estrutura-de-pastas)
- [Fluxo de Dados](#fluxo-de-dados)
- [Componentes Principais](#componentes-principais)
- [Padr√µes Utilizados](#padr√µes-utilizados)
- [Decis√µes Arquiteturais](#decis√µes-arquiteturais)

## üéØ Vis√£o Geral

A **RhSensoERP API** foi desenvolvida seguindo os princ√≠pios da **Clean Architecture**, garantindo:

- ‚úÖ **Separa√ß√£o clara de responsabilidades**
- ‚úÖ **Baixo acoplamento** entre camadas
- ‚úÖ **Alta coes√£o** dentro das camadas
- ‚úÖ **Testabilidade** e **manutenibilidade**
- ‚úÖ **Independ√™ncia de frameworks** e tecnologias

## üèõÔ∏è Clean Architecture

### **Diagrama de Camadas**

```mermaid
graph TB
    subgraph "External"
        Web[Web UI]
        Mobile[Mobile App]
        Tests[Tests]
    end
    
    subgraph "Presentation Layer"
        API[API Controllers]
        Middlewares[Middlewares]
        Filters[Filters]
    end
    
    subgraph "Application Layer"
        UseCases[Use Cases]
        DTOs[DTOs]
        Validators[Validators]
        Interfaces[Interfaces]
    end
    
    subgraph "Infrastructure Layer"
        Persistence[Persistence]
        Identity[Identity]
        Services[External Services]
        Logging[Logging]
    end
    
    subgraph "Domain Layer (Core)"
        Entities[Entities]
        ValueObjects[Value Objects]
        DomainServices[Domain Services]
        Specifications[Specifications]
    end
    
    External --> API
    API --> UseCases
    UseCases --> Entities
    UseCases --> Interfaces
    Interfaces --> Persistence
    Interfaces --> Services
```

### **Fluxo de Depend√™ncias**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    DEPENDENCY RULE                         ‚îÇ
‚îÇ  Source code dependencies can only point INWARDS          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Presentation ‚îÄ‚îÄ‚Üí Application ‚îÄ‚îÄ‚Üí Domain (Core)
     ‚Üì                ‚Üì              ‚Üë
Infrastructure ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚Üë
(implements interfaces defined in Application)
```

## üìÅ Estrutura de Pastas

```
RhSensoERP/
‚îú‚îÄ‚îÄ Src/
‚îÇ   ‚îú‚îÄ‚îÄ API/                           # üåê Presentation Layer
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Controllers/               # Controllers REST
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Middlewares/               # Middlewares customizados
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Configuration/             # Configura√ß√µes de servi√ßos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Program.cs                 # Entry point
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Application/                   # üìã Application Layer
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Security/                  # Casos de uso de seguran√ßa
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Auth/                  # Autentica√ß√£o
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DTOs/              # Data Transfer Objects
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Services/          # Interfaces de servi√ßos
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Validators/        # Validadores FluentValidation
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Users/                 # Gest√£o de usu√°rios
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Common/                    # Componentes comuns
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Behaviors/             # MediatR behaviors
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Interfaces/            # Interfaces da aplica√ß√£o
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Mappings/              # AutoMapper profiles
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Auth/                      # Autoriza√ß√£o
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Infrastructure/                # üîß Infrastructure Layer
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Persistence/               # Acesso a dados
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Configurations/        # EF Core configurations
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Interceptors/          # EF Core interceptors
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AppDbContext.cs        # DbContext principal
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Auth/                      # Implementa√ß√µes de auth
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Services/                  # Implementa√ß√µes de servi√ßos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Repositories/              # Implementa√ß√µes de reposit√≥rios
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Core/                          # üéØ Domain Layer
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Abstractions/              # Abstra√ß√µes base
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Entities/              # Entidades base
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Interfaces/            # Interfaces do dom√≠nio
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Paging/                # Pagina√ß√£o
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Security/                  # Dom√≠nio de seguran√ßa
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Entities/              # Entidades de neg√≥cio
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Permissions/           # Constantes de permiss√µes
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Shared/                    # Componentes compartilhados
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ Modules/                       # üì¶ M√≥dulos de neg√≥cio
‚îÇ       ‚îî‚îÄ‚îÄ SEG/                       # M√≥dulo de Seguran√ßa
‚îÇ
‚îú‚îÄ‚îÄ Tests/                             # üß™ Testes
‚îÇ   ‚îî‚îÄ‚îÄ RhSensoERP.Tests.Unit/         # Testes unit√°rios
‚îÇ
‚îî‚îÄ‚îÄ docs/                              # üìö Documenta√ß√£o
```

## üîÑ Fluxo de Dados

### **1. Fluxo de Requisi√ß√£o T√≠pico**

```mermaid
sequenceDiagram
    participant Client
    participant Controller
    participant Validator
    participant Service
    participant Repository
    participant Database
    
    Client->>Controller: HTTP Request
    Controller->>Validator: Validate DTO
    Validator-->>Controller: Validation Result
    Controller->>Service: Execute Use Case
    Service->>Repository: Query/Command
    Repository->>Database: SQL Query
    Database-->>Repository: Data
    Repository-->>Service: Entity
    Service-->>Controller: Result DTO
    Controller-->>Client: HTTP Response
```

### **2. Fluxo de Autentica√ß√£o**

```mermaid
sequenceDiagram
    participant Client
    participant AuthController
    participant LegacyAuthService
    participant JwtTokenService
    participant Database
    
    Client->>AuthController: POST /auth/login
    AuthController->>LegacyAuthService: AuthenticateAsync()
    LegacyAuthService->>Database: Validate User
    Database-->>LegacyAuthService: User Data
    LegacyAuthService->>Database: Get Permissions
    Database-->>LegacyAuthService: User Permissions
    LegacyAuthService->>JwtTokenService: CreateAccessToken()
    JwtTokenService-->>LegacyAuthService: JWT Token
    LegacyAuthService-->>AuthController: AuthResult
    AuthController-->>Client: LoginResponse + Token
```

## üß© Componentes Principais

### **1. API Layer (Presentation)**

#### **Controllers**
```csharp
[ApiController]
[Route("api/v1/[controller]")]
[Authorize] // Requer autentica√ß√£o por padr√£o
public class BaseController : ControllerBase
{
    // Funcionalidades comuns
}
```

#### **Middlewares**
- **ExceptionHandlingMiddleware**: Captura e padroniza erros
- **SecurityHeadersMiddleware**: Headers de seguran√ßa
- **Rate Limiting**: Prote√ß√£o contra abuso

### **2. Application Layer**

#### **Use Cases / Services**
```csharp
public interface ILegacyAuthService
{
    Task<AuthResult> AuthenticateAsync(string usuario, string senha, CancellationToken ct);
    Task<UserPermissions> GetUserPermissionsAsync(string usuario, CancellationToken ct);
    bool CheckHabilitacao(string sistema, string funcao, UserPermissions permissions);
}
```

#### **DTOs (Data Transfer Objects)**
```csharp
public record LoginRequestDto(string CdUsuario, string Senha);
public record LoginResponseDto(string AccessToken, UserSessionData UserData, 
    List<UserGroup> Groups, List<UserPermission> Permissions);
```

#### **Validators**
```csharp
public class LoginRequestValidator : AbstractValidator<LoginRequestDto>
{
    public LoginRequestValidator()
    {
        RuleFor(x => x.CdUsuario).NotEmpty().Length(1, 30);
        RuleFor(x => x.Senha).NotEmpty().MinimumLength(4);
    }
}
```

### **3. Infrastructure Layer**

#### **Entity Framework Configurations**
```csharp
public class UserConfig : IEntityTypeConfiguration<User>
{
    public void Configure(EntityTypeBuilder<User> builder)
    {
        builder.ToTable("tuse1", schema: "dbo");
        builder.HasKey(x => x.CdUsuario);
        // Mapeamento para sistema legacy
    }
}
```

#### **Repository Pattern**
```csharp
public class EfRepository<T> : IRepository<T> where T : BaseEntity
{
    private readonly AppDbContext _context;
    
    public async Task<T?> GetByIdAsync(Guid id, CancellationToken ct = default)
        => await _context.Set<T>().FindAsync(id, ct);
}
```

### **4. Core/Domain Layer**

#### **Entidades**
```csharp
public class User : AuditableEntity
{
    public string CdUsuario { get; set; } = string.Empty;
    public string DcUsuario { get; set; } = string.Empty;
    public char FlAtivo { get; set; } = 'S';
    
    // Propriedades de conveni√™ncia
    public string Username => CdUsuario;
    public bool Active => FlAtivo == 'S';
}
```

#### **Interfaces de Dom√≠nio**
```csharp
public interface IRepository<T> where T : BaseEntity
{
    Task<T?> GetByIdAsync(Guid id, CancellationToken ct = default);
    Task AddAsync(T entity, CancellationToken ct = default);
    Task UpdateAsync(T entity, CancellationToken ct = default);
}
```

## üé® Padr√µes Utilizados

### **1. Repository Pattern**
- **Prop√≥sito**: Abstra√ß√£o do acesso a dados
- **Implementa√ß√£o**: `IRepository<T>` + `EfRepository<T>`
- **Benef√≠cio**: Testabilidade e substitui√ß√£o de tecnologias

### **2. Unit of Work**
- **Prop√≥sito**: Controle transacional
- **Implementa√ß√£o**: `IUnitOfWork` + `UnitOfWork`
- **Benef√≠cio**: Consist√™ncia de dados

### **3. CQRS (Command Query Responsibility Segregation)**
- **Prop√≥sito**: Separa√ß√£o entre leitura e escrita
- **Implementa√ß√£o**: DTOs espec√≠ficos para cada opera√ß√£o
- **Benef√≠cio**: Performance e clareza

### **4. Specification Pattern**
- **Prop√≥sito**: Consultas complexas reutiliz√°veis
- **Implementa√ß√£o**: Extension methods (ex: `Users.Ativos()`)
- **Benef√≠cio**: Reutiliza√ß√£o e expressividade

### **5. Options Pattern**
- **Prop√≥sito**: Configura√ß√£o tipada
- **Implementa√ß√£o**: `JwtOptions`, `CorsOptions`
- **Benef√≠cio**: Type safety e valida√ß√£o

## üîß Decis√µes Arquiteturais

### **1. Integra√ß√£o com Sistema Legacy**

**Decis√£o**: Mapear diretamente para tabelas existentes sem migrations
```csharp
// UserConfig.cs - Mapeamento direto para tuse1
builder.ToTable("tuse1", schema: "dbo");
builder.HasKey(x => x.CdUsuario); // PK existente
builder.Ignore(x => x.Id); // Propriedade n√£o existe na tabela
```

**Justificativa**:
- ‚úÖ N√£o altera estrutura existente
- ‚úÖ Compatibilidade com sistema atual
- ‚ùå Limita√ß√µes na evolu√ß√£o do modelo

### **2. JWT com Suporte Duplo (HMAC/RSA)**

**Decis√£o**: Chaves sim√©tricas para dev, RSA para produ√ß√£o
```csharp
// AuthExtensions.cs
if (string.IsNullOrEmpty(jwt.PublicKeyPem))
    key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(secretKey));
else
    key = new RsaSecurityKey(rsa);
```

**Justificativa**:
- ‚úÖ Desenvolvimento simplificado
- ‚úÖ Produ√ß√£o mais segura
- ‚úÖ Flexibilidade de deployment

### **3. Clean Architecture Adaptada**

**Decis√£o**: Core cont√©m apenas abstra√ß√µes, dom√≠nio rico nas entidades
```csharp
// User.cs - Propriedades de conveni√™ncia
public string Username => CdUsuario;
public bool Active => FlAtivo == 'S';
```

**Justificativa**:
- ‚úÖ Dom√≠nio expressivo
- ‚úÖ Compatibilidade com legacy
- ‚úÖ Evolu√ß√£o gradual

### **4. Sistema de Permiss√µes Granulares**

**Decis√£o**: Verifica√ß√£o baseada em sistema + fun√ß√£o + a√ß√£o
```csharp
bool CheckBotao(string sistema, string funcao, char acao, UserPermissions permissions)
```

**Justificativa**:
- ‚úÖ Controle fino de acesso
- ‚úÖ Compatibilidade com modelo legacy
- ‚úÖ Auditoria detalhada

### **5. Rate Limiting Diferenciado**

**Decis√£o**: Pol√≠ticas espec√≠ficas por endpoint
```csharp
// Program.cs
options.AddPolicy("login", httpContext => /* 5 tentativas por 15min */);
// Global: 100 requests por minuto
```

**Justificativa**:
- ‚úÖ Prote√ß√£o contra ataques
- ‚úÖ Flexibilidade por contexto
- ‚úÖ UX preservada

## üìä M√©tricas de Qualidade

### **Acoplamento**
- ‚úÖ **Baixo**: Camadas dependem apenas de abstra√ß√µes
- ‚úÖ **Direcionado**: Fluxo unidirecional de depend√™ncias
- ‚úÖ **Controlado**: Invers√£o via DI container

### **Coes√£o**
- ‚úÖ **Alta**: Funcionalidades relacionadas agrupadas
- ‚úÖ **Funcional**: Cada classe tem responsabilidade √∫nica
- ‚úÖ **Modular**: Separa√ß√£o clara por dom√≠nio

### **Testabilidade**
- ‚úÖ **Unit√°ria**: Mocks de todas as depend√™ncias
- ‚úÖ **Integra√ß√£o**: Testes com banco real
- ‚úÖ **E2E**: WebApplicationFactory

## üöÄ Evolu√ß√£o Arquitetural

### **Pr√≥ximos Passos**

1. **Modulariza√ß√£o**
   ```
   Modules/
   ‚îú‚îÄ‚îÄ SEG/ (Seguran√ßa)
   ‚îú‚îÄ‚îÄ RHU/ (Recursos Humanos)
   ‚îú‚îÄ‚îÄ FIN/ (Financeiro)
   ‚îî‚îÄ‚îÄ Shared/
   ```

2. **Event Sourcing**
   - Auditoria completa
   - Eventos de dom√≠nio
   - CQRS avan√ßado

3. **Microservi√ßos**
   - Separa√ß√£o por bounded context
   - Message bus (RabbitMQ/Azure Service Bus)
   - API Gateway

4. **Performance**
   - Redis Cache
   - Query optimization
   - Background jobs

## üìö Refer√™ncias

- **Clean Architecture** - Robert C. Martin
- **Domain-Driven Design** - Eric Evans
- **Enterprise Integration Patterns** - Gregor Hohpe
- **ASP.NET Core Architecture** - Microsoft Docs

---

üí° **Lembre-se**: A arquitetura √© evolutiva. Cada decis√£o deve ser documentada e revisada conforme o projeto cresce.