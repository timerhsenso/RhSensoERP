# üîß Guia de Configura√ß√£o - RhSensoERP API

## üìã √çndice

- [Pr√©-requisitos](#pr√©-requisitos)
- [Configura√ß√£o do Ambiente](#configura√ß√£o-do-ambiente)
- [Banco de Dados](#banco-de-dados)
- [Autentica√ß√£o JWT](#autentica√ß√£o-jwt)
- [Vari√°veis de Ambiente](#vari√°veis-de-ambiente)
- [User Secrets (Desenvolvimento)](#user-secrets-desenvolvimento)
- [Configura√ß√µes por Ambiente](#configura√ß√µes-por-ambiente)
- [Troubleshooting](#troubleshooting)

## üõ†Ô∏è Pr√©-requisitos

### Software Obrigat√≥rio

| Componente | Vers√£o M√≠nima | Recomendado | Download |
|------------|---------------|-------------|----------|
| .NET SDK | 8.0.0 | 8.0.x (latest) | [dotnet.microsoft.com](https://dotnet.microsoft.com/download) |
| SQL Server | 2019 | 2022 | [microsoft.com/sql-server](https://www.microsoft.com/sql-server) |
| Visual Studio | 2022 17.8+ | 2022 (latest) | [visualstudio.microsoft.com](https://visualstudio.microsoft.com/) |

### Para Desenvolvimento Local

```bash
# Verificar vers√µes instaladas
dotnet --version
sqlcmd -?
```

### Portas Utilizadas

| Servi√ßo | Porta | Protocolo | Configur√°vel |
|---------|-------|-----------|--------------|
| **HTTPS** | 57148 | HTTPS | ‚úÖ `launchSettings.json` |
| **HTTP** | 57149 | HTTP | ‚úÖ `launchSettings.json` |
| **SQL Server** | 1433 | TCP | ‚úÖ Connection String |

## üóÑÔ∏è Banco de Dados

### 1. **SQL Server Local (Desenvolvimento)**

```bash
# Instalar LocalDB (se n√£o tiver SQL Server completo)
# Vem com Visual Studio ou baixar SQL Server Express

# Verificar inst√¢ncia
sqllocaldb info
sqllocaldb start MSSQLLocalDB
```

### 2. **Connection String**

‚ö†Ô∏è **NUNCA commitar connection strings com credenciais!**

#### **Op√ß√£o A: User Secrets (Recomendado para dev)**

```bash
# Configurar via User Secrets
cd Src/API
dotnet user-secrets set "ConnectionStrings:Default" "Server=localhost;Database=bd_rhu_copenor;Integrated Security=true;TrustServerCertificate=true;"

# Para SQL Server com usu√°rio/senha
dotnet user-secrets set "ConnectionStrings:Default" "Server=SERVIDOR;Database=bd_rhu_copenor;User Id=usuario;Password=senha;TrustServerCertificate=true;"

# Verificar secrets configurados
dotnet user-secrets list
```

#### **Op√ß√£o B: Vari√°veis de Ambiente**

```bash
# Windows
set ConnectionStrings__Default="Server=localhost;Database=bd_rhu_copenor;Integrated Security=true;TrustServerCertificate=true;"

# Linux/Mac
export ConnectionStrings__Default="Server=localhost;Database=bd_rhu_copenor;Integrated Security=true;TrustServerCertificate=true;"
```

### 3. **Verificar Conectividade**

```bash
# Executar testes de banco
dotnet test Tests/RhSensoERP.Tests.Unit/ --filter "DatabaseTests"

# Ou via API (ap√≥s iniciar)
curl https://localhost:57148/health
curl https://localhost:57148/api/v1/test/banco
```

## üîê Autentica√ß√£o JWT

### 1. **Configura√ß√£o para Desenvolvimento (Chave Sim√©trica)**

```bash
# User Secrets (autom√°tico se chaves PEM n√£o configuradas)
cd Src/API
dotnet user-secrets set "Jwt:SecretKey" "MinhaSuperChaveSecretaParaDesenvolvimento123456789"
dotnet user-secrets set "Jwt:Issuer" "RhSensoERP"
dotnet user-secrets set "Jwt:Audience" "RhSensoERP-Clients"
dotnet user-secrets set "Jwt:AccessTokenMinutes" "30"
```

### 2. **Configura√ß√£o para Produ√ß√£o (Chaves RSA)**

```bash
# Gerar chaves RSA
openssl genrsa -out private.pem 2048
openssl rsa -in private.pem -pubout -out public.pem

# Configurar via vari√°veis de ambiente
export JWT__PublicKeyPem="$(cat public.pem)"
export JWT__PrivateKeyPem="$(cat private.pem)"
export JWT__Issuer="RhSensoERP"
export JWT__Audience="RhSensoERP-Clients"
```

### 3. **Testar JWT**

```bash
# Login para obter token
curl -X POST https://localhost:57148/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"cdUsuario":"admin","senha":"123456"}'

# Usar token em endpoint protegido
curl -H "Authorization: Bearer SEU_TOKEN_AQUI" \
  https://localhost:57148/api/v1/auth/check-habilitacao?cdsistema=SEG&cdfuncao=USUARIO
```

## üåç Vari√°veis de Ambiente

### **Desenvolvimento (appsettings.Development.json)**

```json
{
  "ConnectionStrings": {
    "Default": "CONFIGURAR_VIA_USER_SECRETS"
  },
  "Jwt": {
    "Issuer": "RhSensoERP",
    "Audience": "RhSensoERP-Clients",
    "SecretKey": "CONFIGURAR_VIA_USER_SECRETS",
    "AccessTokenMinutes": 30
  },
  "Cors": {
    "AllowedOrigins": [
      "https://localhost:7050",
      "http://localhost:3000",
      "http://localhost:4200"
    ]
  },
  "Serilog": {
    "MinimumLevel": "Debug"
  }
}
```

### **Produ√ß√£o (Vari√°veis de Ambiente)**

```bash
# Banco de dados
export ConnectionStrings__Default="Server=prod-server;Database=bd_rhu_copenor;User Id=api_user;Password=***;TrustServerCertificate=false;"

# JWT (chaves RSA)
export Jwt__PublicKeyPem="-----BEGIN PUBLIC KEY-----\n...\n-----END PUBLIC KEY-----"
export Jwt__PrivateKeyPem="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----"
export Jwt__Issuer="RhSensoERP-Production"
export Jwt__Audience="RhSensoERP-Clients"
export Jwt__AccessTokenMinutes="15"

# CORS (apenas origens autorizadas)
export Cors__AllowedOrigins__0="https://app.rhsenso.com"
export Cors__AllowedOrigins__1="https://admin.rhsenso.com"

# Logging
export Serilog__MinimumLevel="Warning"
export ASPNETCORE_ENVIRONMENT="Production"
```

## üîí User Secrets (Desenvolvimento)

### **Configura√ß√£o Completa**

```bash
cd Src/API

# Connection String
dotnet user-secrets set "ConnectionStrings:Default" "Server=localhost;Database=bd_rhu_copenor;Integrated Security=true;TrustServerCertificate=true;"

# JWT
dotnet user-secrets set "Jwt:SecretKey" "MinhaChaveSecretaParaDev123456789AbCdEf"
dotnet user-secrets set "Jwt:Issuer" "RhSensoERP-Dev"
dotnet user-secrets set "Jwt:Audience" "RhSensoERP-Dev-Clients"
dotnet user-secrets set "Jwt:AccessTokenMinutes" "60"

# Verificar
dotnet user-secrets list

# Limpar (se necess√°rio)
dotnet user-secrets clear
```

### **Arquivo de exemplo (.secrets-template)**

```json
{
  "ConnectionStrings": {
    "Default": "Server=SEU_SERVIDOR;Database=bd_rhu_copenor;Integrated Security=true;TrustServerCertificate=true;"
  },
  "Jwt": {
    "SecretKey": "SUA_CHAVE_SECRETA_AQUI_MIN_32_CHARS",
    "Issuer": "RhSensoERP-Dev",
    "Audience": "RhSensoERP-Dev-Clients",
    "AccessTokenMinutes": 60
  }
}
```

## üöÄ Configura√ß√µes por Ambiente

### **Development**
- User Secrets para credenciais
- Logs detalhados (Debug)
- Swagger habilitado
- CORS permissivo
- Rate limiting relaxado

### **Staging**
- Vari√°veis de ambiente
- Logs moderados (Information)
- Swagger habilitado
- CORS restrito
- Rate limiting normal

### **Production**
- Vari√°veis de ambiente criptografadas
- Logs m√≠nimos (Warning/Error)
- Swagger desabilitado
- CORS muito restrito
- Rate limiting rigoroso
- HTTPS obrigat√≥rio

## üÜò Troubleshooting

### **1. Erro de Connection String**

```
‚ùå "Cannot open database bd_rhu_copenor"
```

**Solu√ß√µes:**
```bash
# Verificar se SQL Server est√° rodando
sqlcmd -S localhost -E -Q "SELECT @@VERSION"

# Verificar se banco existe
sqlcmd -S localhost -E -Q "SELECT name FROM sys.databases WHERE name = 'bd_rhu_copenor'"

# Testar connection string manualmente
dotnet test --filter "Deve_Conectar_Com_Banco"
```

### **2. Erro de JWT**

```
‚ùå "IDX10503: Signature validation failed"
```

**Solu√ß√µes:**
```bash
# Verificar configura√ß√£o JWT
dotnet user-secrets list | grep Jwt

# Reconfigurar chave
dotnet user-secrets set "Jwt:SecretKey" "NovaChaveSecreta123456789AbCdEf"
```

### **3. Erro de Porta**

```
‚ùå "Failed to bind to address https://localhost:57148"
```

**Solu√ß√µes:**
```bash
# Verificar portas em uso
netstat -an | findstr :57148

# Alterar porta no launchSettings.json
# ou usar porta diferente
dotnet run --urls="https://localhost:5001"
```

### **4. Erro de CORS**

```
‚ùå "CORS policy: No 'Access-Control-Allow-Origin' header"
```

**Solu√ß√µes:**
```bash
# Adicionar origem no appsettings
# ou user secrets
dotnet user-secrets set "Cors:AllowedOrigins:0" "http://localhost:3000"
```

### **5. Problemas com Testes**

```bash
# Erro: banco n√£o encontrado nos testes
# Os testes usam SQLite em mem√≥ria, mas alguns usam SQL Server

# Para testes que precisam do banco real:
dotnet user-secrets set "ConnectionStrings:Default" "SUA_CONNECTION_STRING" --project Tests/RhSensoERP.Tests.Unit/

# Ou pular testes de banco:
dotnet test --filter "FullyQualifiedName!~DatabaseTests"
```

## ‚úÖ Verifica√ß√£o Final

```bash
# 1. Verificar configura√ß√£o
dotnet user-secrets list --project Src/API

# 2. Executar aplica√ß√£o
dotnet run --project Src/API

# 3. Testar endpoints
curl https://localhost:57148/health
curl https://localhost:57148/swagger

# 4. Executar testes
dotnet test

# 5. Verificar logs
# Arquivos em: Src/API/logs/
```

---

üí° **Dica:** Mantenha um arquivo `.env.example` no reposit√≥rio com exemplos de todas as vari√°veis necess√°rias (sem valores reais).